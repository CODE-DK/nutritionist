# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –§–æ—Ç–æ-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã (KILLER FEATURE)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–Ω–µ–≤–Ω–∏–∫–∞ –ø–∏—Ç–∞–Ω–∏—è, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–≤–æ–¥—è—Ç –µ–¥—É –≤—Ä—É—á–Ω—É—é. –°–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º, 70% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—Ä–æ—Å–∞—é—Ç —Ñ–∏—Ç–Ω–µ—Å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑-–∑–∞ "–ª–µ–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ". –¢–µ–∫—É—â–∞—è retention —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ~15-20%.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ–¥—ã —á–µ—Ä–µ–∑ Claude Vision API, –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–ª—é–¥–æ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞–ª–æ—Ä–∏–∏/–ë–ñ–£. –≠—Ç–æ —Å–Ω–∏–∑–∏—Ç friction —Å 10+ –∫–ª–∏–∫–æ–≤ –¥–æ 2 –∫–ª–∏–∫–æ–≤ –∏ –ø–æ–≤—ã—Å–∏—Ç 7-day retention –¥–æ 40-50%.

**–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω–Ω–æ—Å—Ç—å:**
- Retention: 15-20% ‚Üí 40-50% (2.5x improvement)
- –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è: –ª–∏–º–∏—Ç 5 —Ñ–æ—Ç–æ/–¥–µ–Ω—å –¥–ª—è Free ‚Üí –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π paywall –¥–ª—è Premium
- –£–¢–ü: –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è AI —Ñ–æ—Ç–æ + AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —Ç–∞–∫ –Ω–µ —É–º–µ—é—Ç)
- ROI: –û–∫—É–ø–∞–µ—Ç—Å—è –ø—Ä–∏ 100 Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö ($499 MRR vs ~$500/–º–µ—Å costs)

**–†–∏—Å–∫–∏ –±–µ–∑ —Ñ–æ—Ç–æ:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç "–µ—â–µ –æ–¥–Ω–∏–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –∫–∞–ª–æ—Ä–∏–π" —Å –Ω–∏–∑–∫–æ–π retention –∏ –ø—Ä–æ–≤–∞–ª–æ–º –º–µ—Ç—Ä–∏–∫.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤):

```
1. Frontend Service: /src/services/photoService.ts (NEW)
   ‚îî‚îÄ –õ–æ–≥–∏–∫–∞: capture, compress, upload, analyze

2. Frontend UI: /src/components/PhotoCaptureModal.tsx (NEW)
   ‚îî‚îÄ –§–ª–æ—É: –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

3. Integration: /src/components/AddMealModal.tsx (MODIFY)
   ‚îî‚îÄ –î–æ–±–∞–≤–∏—Ç—å: –∫–Ω–æ–ø–∫—É —Ñ–æ—Ç–æ, —Å—á–µ—Ç—á–∏–∫ –ª–∏–º–∏—Ç–∞, auto-fill

4. Backend: /supabase/functions/analyze-food-photo/index.ts (NEW)
   ‚îî‚îÄ Edge Function: JWT auth ‚Üí Claude Vision API ‚Üí JSON response

5. Database: /supabase/migrations/003_add_photo_support.sql (NEW)
   ‚îî‚îÄ –†–∞—Å—à–∏—Ä–∏—Ç—å: food_diary + photo_usage table + RLS policies
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:

```
User taps "üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å"
  ‚Üì
PhotoCaptureModal: –≤—ã–±–æ—Ä –ö–∞–º–µ—Ä–∞/–ì–∞–ª–µ—Ä–µ—è (expo-image-picker)
  ‚Üì
photoService.compressImage(): resize –¥–æ 1024px, quality 0.8
  ‚Üì
photoService.imageToBase64(): –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è API
  ‚Üì
Edge Function /analyze-food-photo:
  - JWT auth
  - Check photo limit (5/day Free)
  - Claude Vision API call
  - Parse JSON: dish_name, calories, protein, carbs, fat, confidence
  - Increment usage counter
  ‚Üì
AddMealModal: auto-fill —Ñ–æ—Ä–º—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
  ‚Üì
photoService.uploadToStorage(): async upload –≤ food-photos bucket
  ‚Üì
diaryService.addMeal(): save —Å photo_url + ai_confidence
```

---

## –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ó–∞–¥–∞—á–∞:** –î–æ–±–∞–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ç–æ –∏ AI.

```bash
npx expo install expo-image-picker expo-camera expo-file-system
npm install @anthropic-ai/sdk
```

**–û–±–Ω–æ–≤–∏—Ç—å:** `/package.json` –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–æ–≤—ã–µ dependencies.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `npm list expo-image-picker` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é.

---

## –®–∞–≥ 2: Database –º–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `/supabase/migrations/003_add_photo_support.sql` (CREATE)

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
1. –†–∞—Å—à–∏—Ä–∏—Ç—å `food_diary`:
   ```sql
   ALTER TABLE food_diary
     ADD COLUMN photo_url TEXT,
     ADD COLUMN ai_confidence FLOAT CHECK (ai_confidence >= 0 AND ai_confidence <= 1),
     ADD COLUMN ai_reasoning TEXT;
   ```

2. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `photo_usage` –¥–ª—è –ª–∏–º–∏—Ç–æ–≤:
   ```sql
   CREATE TABLE photo_usage (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     user_id UUID REFERENCES users(id) ON DELETE CASCADE,
     usage_date DATE NOT NULL,
     count INTEGER DEFAULT 0 CHECK (count >= 0),
     UNIQUE(user_id, usage_date)
   );
   ```

3. RLS policies:
   - `food_diary`: —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è policy —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
   - `photo_usage`: user can SELECT own records
   - Storage bucket `food-photos`: user can INSERT/SELECT/DELETE only own folder

4. PostgreSQL Function:
   ```sql
   CREATE FUNCTION increment_photo_usage(p_user_id UUID, p_date DATE)
   RETURNS void AS $$
   BEGIN
     INSERT INTO photo_usage (user_id, usage_date, count) VALUES (p_user_id, p_date, 1)
     ON CONFLICT (user_id, usage_date) DO UPDATE SET count = photo_usage.count + 1;
   END;
   $$ LANGUAGE plpgsql SECURITY DEFINER;
   ```

5. –ò–Ω–¥–µ–∫—Å—ã:
   ```sql
   CREATE INDEX idx_food_diary_photo ON food_diary(user_id, photo_url) WHERE photo_url IS NOT NULL;
   CREATE INDEX idx_photo_usage_user_date ON photo_usage(user_id, usage_date DESC);
   ```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å:**
```bash
cd supabase
supabase db push
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `supabase db diff` –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—É.

---

## –®–∞–≥ 3: Supabase Storage setup

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å bucket –¥–ª—è —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ Supabase Dashboard.

**–ß–µ—Ä–µ–∑ Dashboard:**
1. Storage ‚Üí Create Bucket ‚Üí Name: `food-photos`, Public: true
2. SQL Editor ‚Üí Run policies:
   ```sql
   CREATE POLICY "Users upload to own folder" ON storage.objects FOR INSERT
     WITH CHECK (bucket_id = 'food-photos' AND auth.uid()::text = (storage.foldername(name))[1]);

   CREATE POLICY "Users read own photos" ON storage.objects FOR SELECT
     USING (bucket_id = 'food-photos' AND auth.uid()::text = (storage.foldername(name))[1]);

   CREATE POLICY "Users delete own photos" ON storage.objects FOR DELETE
     USING (bucket_id = 'food-photos' AND auth.uid()::text = (storage.foldername(name))[1]);
   ```

**Bucket settings:**
- Max file size: 2MB
- Allowed MIME types: image/jpeg, image/png

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** Storage ‚Üí food-photos bucket –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

---

## –®–∞–≥ 4: Edge Function –¥–ª—è Claude Vision

**–§–∞–π–ª:** `/supabase/functions/analyze-food-photo/index.ts` (CREATE)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ `/supabase/functions/chat-gpt/index.ts`:
- CORS handling (OPTIONS preflight)
- JWT auth —á–µ—Ä–µ–∑ `supabase.auth.getUser()`
- Error handling –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞:**

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import Anthropic from 'https://esm.sh/@anthropic-ai/sdk@0.20.0';

const ANTHROPIC_API_KEY = Deno.env.get('ANTHROPIC_API_KEY');

serve(async (req) => {
  // 1. CORS + JWT auth (–∫–∞–∫ –≤ chat-gpt)
  // 2. Parse body: { image: base64, userId: uuid }
  // 3. Check photo limit: call checkPhotoLimit()
  // 4. Claude Vision API call:
  const anthropic = new Anthropic({ apiKey: ANTHROPIC_API_KEY });
  const message = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20250219',
    max_tokens: 1024,
    messages: [{
      role: 'user',
      content: [
        { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: image } },
        { type: 'text', text: FOOD_RECOGNITION_PROMPT }
      ]
    }]
  });
  // 5. Parse JSON response (extract from markdown if needed)
  // 6. Validate: dish_name required, calories 0-5000, confidence 0-1
  // 7. Increment usage: await supabase.rpc('increment_photo_usage')
  // 8. Return JSON: { dish_name, calories, protein, carbs, fat, confidence, reasoning }
});
```

**–ü—Ä–æ–º–ø—Ç:**
```typescript
const FOOD_RECOGNITION_PROMPT = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ —Ñ–æ—Ç–æ –µ–¥—ã –∏ –≤–µ—Ä–Ω–∏ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –±–ª—é–¥–µ.

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–ª—é–¥, —Å—É–º–º–∏—Ä—É–π –∫–∞–ª–æ—Ä–∏–∏
- –£–∫–∞–∑—ã–≤–∞–π —Ç–∏–ø–∏—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ –¥–ª—è –†–æ—Å—Å–∏–∏/–°–ù–ì
- –ë—É–¥—å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–µ–Ω –≤ –æ—Ü–µ–Ω–∫–µ –∫–∞–ª–æ—Ä–∏–π (–ª—É—á—à–µ –±–æ–ª—å—à–µ)

–§–û–†–ú–ê–¢ (—Å—Ç—Ä–æ–≥–æ JSON –±–µ–∑ markdown):
{
  "dish_name": "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "calories": 450,
  "protein": 25,
  "carbs": 55,
  "fat": 12,
  "confidence": 0.85,
  "reasoning": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏"
}

–ï—Å–ª–∏ confidence < 0.3, –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–∞–π –æ—Ü–µ–Ω–∫—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å).`;
```

**Deploy:**
```bash
supabase secrets set ANTHROPIC_API_KEY=sk-ant-...
supabase functions deploy analyze-food-photo
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
curl -i --location --request POST \
  'https://YOUR_PROJECT.supabase.co/functions/v1/analyze-food-photo' \
  --header 'Authorization: Bearer YOUR_TOKEN' \
  --header 'Content-Type: application/json' \
  --data '{"image": "base64...", "userId": "uuid"}'
```

---

## –®–∞–≥ 5: Frontend Service (photoService.ts)

**–§–∞–π–ª:** `/src/services/photoService.ts` (CREATE)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```typescript
class PhotoService {
  // 1. Permissions
  async requestCameraPermission(): Promise<boolean>
  async requestMediaLibraryPermission(): Promise<boolean>

  // 2. Capture/Pick
  async capturePhoto(): Promise<string | null>  // expo-image-picker.launchCameraAsync
  async pickFromGallery(): Promise<string | null>  // expo-image-picker.launchImageLibraryAsync

  // 3. Processing
  async compressImage(uri: string, maxSizeBytes = 2MB): Promise<string>  // resize 1024px, quality 0.8
  async imageToBase64(uri: string): Promise<string>  // FileSystem.readAsStringAsync

  // 4. API calls
  async analyzeFood(photoUri: string, userId: string): Promise<PhotoAnalysisResult> {
    // - compressImage()
    // - imageToBase64()
    // - supabase.functions.invoke('analyze-food-photo')
    // - uploadToStorage() (async, non-blocking)
    // - return { dishName, calories, protein, carbs, fat, confidence, reasoning, photoUri, photoUrl }
  }

  async uploadToStorage(uri: string, userId: string): Promise<string> {
    // - fetch(uri) ‚Üí blob
    // - supabase.storage.from('food-photos').upload(`${userId}/${timestamp}.jpg`, blob)
    // - return publicUrl
  }

  // 5. Limits
  async getPhotoUsage(userId: string): Promise<{ current, limit, remaining }>
  async canTakePhoto(userId: string): Promise<boolean>

  // 6. Cleanup
  async cleanupOldPhotos(userId: string, daysToKeep = 30): Promise<void>
}
```

**Error handling:** Wrap –≤ try-catch, –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å ApiError —Å code:
- `CAMERA_PERMISSION_DENIED`
- `LOW_CONFIDENCE` (< 0.3)
- `PHOTO_LIMIT_EXCEEDED`
- `NETWORK_ERROR`
- `EDGE_FUNCTION_ERROR`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
- Error handling –∫–∞–∫ –≤ `/src/services/aiService.ts`
- API calls —á–µ—Ä–µ–∑ `supabase.functions.invoke()` –∫–∞–∫ –≤ aiService
- –¢–∏–ø—ã –∏–∑ `/src/types/index.ts`

---

## –®–∞–≥ 6: Frontend UI (PhotoCaptureModal)

**–§–∞–π–ª:** `/src/components/PhotoCaptureModal.tsx` (CREATE)

**Props:**
```typescript
interface PhotoCaptureModalProps {
  visible: boolean;
  onClose: () => void;
  onPhotoSelected: (result: PhotoAnalysisResult) => void;
}
```

**States:**
- `idle`: –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "üì∑ –ö–∞–º–µ—Ä–∞" / "üñº –ì–∞–ª–µ—Ä–µ—è"
- `capturing`: expo-image-picker open (handled by OS)
- `preview`: –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ + –∫–Ω–æ–ø–∫–∏ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" / "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
- `analyzing`: –ª–æ–∞–¥–µ—Ä "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –ø–æ–º–æ—â—å—é AI..." (2-4 —Å–µ–∫)
- `result`: –ø–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å confidence % + –∫–Ω–æ–ø–∫–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"
- `error`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–∏–∑–∫–∏–π confidence, –Ω–µ—Ç –µ–¥—ã, API error)

**UI components:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- `Button` –∏–∑ `/src/components/Button.tsx`
- `Loading` –∏–∑ `/src/components/Loading.tsx`
- `Colors, Typography, Spacing` –∏–∑ `/src/config/theme.ts`
- `useTheme()` –∏–∑ `/src/config/ThemeContext.tsx`

**–§–ª–æ—É:**
```typescript
const handleCameraPress = async () => {
  const uri = await photoService.capturePhoto();
  if (uri) {
    setPhotoUri(uri);
    setState('preview');
  }
};

const handleAnalyze = async () => {
  setState('analyzing');
  try {
    const result = await photoService.analyzeFood(photoUri, userId);
    if (result.confidence < 0.3) {
      setState('error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –µ–¥—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.');
    } else {
      onPhotoSelected(result);
      onClose();
    }
  } catch (error) {
    setState('error');
    setError(error.message);
  }
};
```

---

## –®–∞–≥ 7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ AddMealModal

**–§–∞–π–ª:** `/src/components/AddMealModal.tsx` (MODIFY)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–ù–æ–≤—ã–µ imports:**
   ```typescript
   import PhotoCaptureModal from './PhotoCaptureModal';
   import photoService from '../services/photoService';
   ```

2. **–ù–æ–≤—ã–µ states:**
   ```typescript
   const [photoModalVisible, setPhotoModalVisible] = useState(false);
   const [photoResult, setPhotoResult] = useState<PhotoAnalysisResult | null>(null);
   const [photoUsage, setPhotoUsage] = useState({ current: 0, limit: 5, remaining: 5 });
   ```

3. **useEffect –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–º–∏—Ç–∞:**
   ```typescript
   useEffect(() => {
     if (visible && userId) {
       loadPhotoUsage();
     }
   }, [visible, userId]);

   const loadPhotoUsage = async () => {
     try {
       const usage = await photoService.getPhotoUsage(userId);
       setPhotoUsage(usage);
     } catch (error) {
       console.error('Failed to load photo usage:', error);
     }
   };
   ```

4. **–ö–Ω–æ–ø–∫–∞ —Ñ–æ—Ç–æ (–¥–æ–±–∞–≤–∏—Ç—å –ü–ï–†–ï–î "–¢–∏–ø –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏"):**
   ```typescript
   {/* Photo Button */}
   <TouchableOpacity
     style={styles.photoButton}
     onPress={() => setPhotoModalVisible(true)}
     disabled={loading || photoUsage.remaining === 0}
   >
     <Ionicons name="camera" size={24} color={theme.primary} />
     <Text style={styles.photoButtonText}>üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å</Text>
     <Text style={styles.photoCounter}>
       {photoUsage.remaining}/{photoUsage.limit} —Å–µ–≥–æ–¥–Ω—è
     </Text>
   </TouchableOpacity>

   {photoUsage.remaining === 0 && (
     <View style={styles.limitBanner}>
       <Text>–õ–∏–º–∏—Ç —Ñ–æ—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. Premium = –±–µ–∑–ª–∏–º–∏—Ç üöÄ</Text>
       <Button title="–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ" onPress={showPaywall} variant="text" />
     </View>
   )}
   ```

5. **Callback –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞:**
   ```typescript
   const handlePhotoAnalyzed = (result: PhotoAnalysisResult) => {
     setPhotoResult(result);

     // Auto-fill —Ñ–æ—Ä–º—ã
     setName(result.dishName);
     setCalories(result.calories.toString());
     setProtein(result.protein.toString());
     setCarbs(result.carbs.toString());
     setFat(result.fat.toString());

     // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä AI
     if (result.confidence >= 0.7) {
       Alert.alert('‚úì AI —Ä–∞—Å–ø–æ–∑–Ω–∞–ª', `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${Math.round(result.confidence * 100)}%`);
     } else {
       Alert.alert('‚ö† –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ');
     }

     setPhotoModalVisible(false);
   };
   ```

6. **–ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ –≤ —Ñ–æ—Ä–º–µ (–ø–æ—Å–ª–µ –ë–ñ–£ inputs):**
   ```typescript
   {photoResult && (
     <View style={styles.aiIndicator}>
       <Ionicons name="sparkles" size={16} color={theme.primary} />
       <Text>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é AI ({Math.round(photoResult.confidence * 100)}%)</Text>
     </View>
   )}

   {photoResult?.photoUri && (
     <View style={styles.photoPreview}>
       <Image source={{ uri: photoResult.photoUri }} style={styles.photoImage} />
       <TouchableOpacity onPress={() => setPhotoResult(null)}>
         <Ionicons name="close-circle" size={24} color={theme.error} />
       </TouchableOpacity>
     </View>
   )}
   ```

7. **–û–±–Ω–æ–≤–∏—Ç—å handleSave:**
   ```typescript
   const meal: Omit<FoodEntry, 'id' | 'timestamp'> = {
     // ... existing fields
     photoUrl: photoResult?.photoUrl,
     aiConfidence: photoResult?.confidence,
     aiReasoning: photoResult?.reasoning,
   };
   ```

8. **Modal:**
   ```typescript
   <PhotoCaptureModal
     visible={photoModalVisible}
     onClose={() => setPhotoModalVisible(false)}
     onPhotoSelected={handlePhotoAnalyzed}
   />
   ```

**–í–∞–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É (–≤–∞–ª–∏–¥–∞—Ü–∏—è, editing, resetForm) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## –®–∞–≥ 8: –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã

**–§–∞–π–ª:** `/src/types/index.ts` (MODIFY)

**–î–æ–±–∞–≤–∏—Ç—å:**

```typescript
export interface PhotoAnalysisResult {
  dishName: string;
  calories: number;
  protein: number;
  carbs: number;
  fat: number;
  confidence: number;  // 0.0 - 1.0
  reasoning: string;
  photoUri: string;    // Local URI
  photoUrl?: string;   // Storage URL
}

export interface PhotoUsage {
  current: number;
  limit: number;
  remaining: number;
}

// –†–∞—Å—à–∏—Ä–∏—Ç—å FoodEntry:
export interface FoodEntry {
  // ... existing fields
  photoUrl?: string;
  aiConfidence?: number;
  aiReasoning?: string;
}
```

---

## –®–∞–≥ 9: –û–±–Ω–æ–≤–∏—Ç—å constants

**–§–∞–π–ª:** `/src/config/constants.ts` (MODIFY)

**–î–æ–±–∞–≤–∏—Ç—å:**

```typescript
export const APP_CONFIG = {
  // ... existing
  FREE_PHOTO_LIMIT: 5,
  PREMIUM_PHOTO_LIMIT: 999,
  MAX_PHOTO_SIZE_MB: 2,
  PHOTO_CLEANUP_DAYS: 30,
};

export const PHOTO_CONFIG = {
  COMPRESSION_QUALITY: 0.8,
  MAX_WIDTH: 1024,
  MIN_CONFIDENCE: 0.3,
  GOOD_CONFIDENCE: 0.7,
};
```

---

## –®–∞–≥ 10: –û–±–Ω–æ–≤–∏—Ç—å diaryService

**–§–∞–π–ª:** `/src/services/diaryService.ts` (MODIFY)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. –í `addMeal()` –∏ `updateMeal()` –¥–æ–±–∞–≤–∏—Ç—å mapping –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:
   ```typescript
   const insertData = {
     // ... existing fields
     photo_url: meal.photoUrl || null,
     ai_confidence: meal.aiConfidence || null,
     ai_reasoning: meal.aiReasoning || null,
   };
   ```

2. –í `mapToFoodEntry()` –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π mapping:
   ```typescript
   return {
     // ... existing fields
     photoUrl: data.photo_url,
     aiConfidence: data.ai_confidence,
     aiReasoning: data.ai_reasoning,
   };
   ```

---

## Verification (End-to-End —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

### Test Case 1: –£—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å app: `npm start` ‚Üí iOS simulator
2. –û—Ç–∫—Ä—ã—Ç—å DiaryScreen ‚Üí tap FAB "+" (Add Meal)
3. –í AddMealModal ‚Üí tap –∫–Ω–æ–ø–∫—É "üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å"
4. PhotoCaptureModal –ø–æ—è–≤–∏–ª—Å—è ‚Üí tap "–ö–∞–º–µ—Ä–∞" (–∏–ª–∏ "–ì–∞–ª–µ—Ä–µ—è" –≤ simulator)
5. –í—ã–±—Ä–∞—Ç—å/—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –µ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç)
6. –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ –ø–æ—è–≤–∏–ª–æ—Å—å ‚Üí tap "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
7. –õ–æ–∞–¥–µ—Ä "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º..." (2-4 —Å–µ–∫)
8. **Expected:** AddMealModal auto-filled:
   - Name: "–ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç" (–∏–ª–∏ –ø–æ—Ö–æ–∂–µ–µ)
   - Calories: 280-350 –∫–∫–∞–ª
   - Protein/Carbs/Fat –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é AI (85%)" –≤–∏–¥–∏–º
9. Tap "–î–æ–±–∞–≤–∏—Ç—å" ‚Üí meal saved
10. **Expected:** –í DiaryScreen –ø–æ—è–≤–∏–ª–∞—Å—å –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –±–ª—é–¥–æ–º + –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ

### Test Case 2: –õ–∏–º–∏—Ç —Ñ–æ—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç

1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ-—Ñ—É–Ω–∫—Ü–∏—é 5 —Ä–∞–∑ (5 –±–ª—é–¥)
2. –û—Ç–∫—Ä—ã—Ç—å AddMealModal –≤ 6-–π —Ä–∞–∑
3. **Expected:** –ö–Ω–æ–ø–∫–∞ "üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å" disabled
4. **Expected:** Banner "–õ–∏–º–∏—Ç —Ñ–æ—Ç–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç. Premium = –±–µ–∑–ª–∏–º–∏—Ç üöÄ" –≤–∏–¥–∏–º
5. Tap "–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ" ‚Üí PaywallScreen –æ—Ç–∫—Ä—ã–ª—Å—è

### Test Case 3: –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI

1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–º—ã—Ç–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–µ-–µ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–ª–µ—Ñ–æ–Ω)
2. **Expected:** PhotoCaptureModal –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É:
   - "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –µ–¥—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ"
   - –ö–Ω–æ–ø–∫–∏ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" / "–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é"
3. Tap "–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é" ‚Üí AddMealModal —Å –ø—É—Å—Ç—ã–º–∏ –ø–æ–ª—è–º–∏

### Test Case 4: Offline —Ä–µ–∂–∏–º

1. –í—ã–∫–ª—é—á–∏—Ç—å Wi-Fi/Cellular –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ
3. **Expected:** Error "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
4. –í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ‚Üí tap "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" ‚Üí —É—Å–ø–µ—Ö

### Database Verification:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ photo_url —Å–æ—Ö—Ä–∞–Ω–µ–Ω
SELECT id, food_name, photo_url, ai_confidence
FROM food_diary
WHERE photo_url IS NOT NULL
LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
SELECT user_id, usage_date, count
FROM photo_usage
WHERE usage_date = CURRENT_DATE;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã –≤ Storage
SELECT name, created_at
FROM storage.objects
WHERE bucket_id = 'food-photos'
ORDER BY created_at DESC
LIMIT 5;
```

### Performance Verification:

- Photo compression: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚â§ 2MB
- API response time: ‚â§ 5 seconds (p95)
- App –Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–æ—Ç–æ
- Memory usage —Å—Ç–∞–±–∏–ª–µ–Ω (–Ω–µ—Ç leaks)

### Cost Verification (–ø–æ—Å–ª–µ 100 —Ñ–æ—Ç–æ):

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å spend –≤ Anthropic Dashboard
# Expected: ~$0.80 –∑–∞ 100 —Ñ–æ—Ç–æ (–µ—Å–ª–∏ $0.008/—Ñ–æ—Ç–æ)
```

---

## Success Metrics (–ø–æ—Å–ª–µ 2 –Ω–µ–¥–µ–ª—å)

**Primary:**
- ‚úì Photo Usage Rate: ‚â•40% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ñ–æ—Ç–æ
- ‚úì Photo Success Rate: ‚â•70% —Ñ–æ—Ç–æ —Å confidence >0.5
- ‚úì Edit Rate: ‚â§30% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**Secondary:**
- Average confidence: ‚â•0.75
- Processing time: ‚â§4 —Å–µ–∫ (p95)
- Error rate: ‚â§5%
- Cost per photo: ‚â§$0.01

**Business (–ø–æ—Å–ª–µ 90 –¥–Ω–µ–π):**
- 7-Day Retention: ‚â•40% (up from 20%)
- Photo Limit Conversion: ‚â•20% hit limit ‚Üí view paywall
- Premium Conversions: ‚â•5% upgrade to Premium

---

## Rollback Plan

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Disable Edge Function:**
   ```bash
   supabase functions delete analyze-food-photo
   ```

2. **Hide UI:** –í AddMealModal –¥–æ–±–∞–≤–∏—Ç—å feature flag:
   ```typescript
   const PHOTO_FEATURE_ENABLED = false;
   {PHOTO_FEATURE_ENABLED && <PhotoButton />}
   ```

3. **Database:** –ö–æ–ª–æ–Ω–∫–∏ `photo_url`, `ai_confidence` nullable, –ø–æ—ç—Ç–æ–º—É –Ω–µ –ª–æ–º–∞—é—Ç existing —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

4. **Costs:** –ï—Å–ª–∏ spend >$50/–¥–µ–Ω—å, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ disable —á–µ—Ä–µ–∑ env variable.

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:**

1. **`/supabase/migrations/003_add_photo_support.sql`** - Database foundation, –±–µ–∑ —ç—Ç–æ–≥–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **`/supabase/functions/analyze-food-photo/index.ts`** - Core AI logic, backbone —Ñ–∏—á–∏
3. **`/src/services/photoService.ts`** - Business logic, centralizes –≤—Å–µ photo operations
4. **`/src/components/PhotoCaptureModal.tsx`** - UI flow, –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è UX
5. **`/src/components/AddMealModal.tsx`** - Integration point, —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å—ë –≤–º–µ—Å—Ç–µ

**–ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 (database first, UI last)

---

## –ò—Ç–æ–≥–æ: 5 –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã

- –î–µ–Ω—å 1: Database + Storage setup (–®–∞–≥–∏ 1-3)
- –î–µ–Ω—å 2: Edge Function (–®–∞–≥ 4)
- –î–µ–Ω—å 3: photoService.ts (–®–∞–≥ 5)
- –î–µ–Ω—å 4: PhotoCaptureModal + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–®–∞–≥–∏ 6-7)
- –î–µ–Ω—å 5: Testing + bug fixes (–®–∞–≥ 10)

**–ì–æ—Ç–æ–≤ –∫ implementation!** üöÄ
